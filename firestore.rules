rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----- public user profiles -----
    match /users/{userId} {
      allow get, list: if true;
      allow create, update, delete: if request.auth != null && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['name', 'email'])
        && request.resource.data.email == request.auth.token.email;
    }

    // ----- swipes -----
    match /swipes/{userId}/swipedOn/{otherId} {
      allow get, list: if request.auth != null && request.auth.uid == userId;
      allow create, update, delete: if request.auth != null && request.auth.uid == userId
        && request.resource.data.liked is bool;
    }

    // ----- matches -----
    match /matches/{matchId} {
      allow get, list: if request.auth != null && request.auth.uid in resource.data.users;
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll(['users','createdAt'])
        && request.resource.data.users is list
        && request.resource.data.users.size() == 2
        && request.auth.uid in request.resource.data.users;
      allow update, delete: if request.auth != null && request.auth.uid in resource.data.users;
    }

    // ----- chat messages -----
    match /chats/{matchId}/messages/{messageId} {
      allow get, list: if request.auth != null && exists(/databases/$(database)/documents/matches/$(matchId))
        && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
      allow create: if request.auth != null
        && exists(/databases/$(database)/documents/matches/$(matchId))
        && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users
        && request.resource.data.keys().hasAll(['from','text','sentAt'])
        && request.resource.data.from == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0;
      allow update, delete: if false;
    }

    // fallback â€” deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}